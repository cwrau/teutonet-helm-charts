name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - charts/**
  workflow_dispatch: {}

jobs:
  changeFinder:
    runs-on: ubuntu-latest
    outputs:
      changedCharts: ${{ steps.getChangedCharts.outputs.changedCharts }}
    steps:
      - uses: actions/checkout@v2
      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.3.1
      - id: getChangedCharts
        run: |
          (
            echo -n changedCharts=
            ct list-changed --target-branch main --since HEAD~ | jq -c -Rn '[inputs]'
          ) | tee $GITHUB_OUTPUT
  release-please-release:
    runs-on: ubuntu-latest
    needs:
      - changeFinder
    strategy:
      fail-fast: false
      matrix:
        chart: ${{fromJson(needs.changeFinder.outputs.changedCharts)}}
    steps:
      - uses: google-github-actions/release-please-action@v3
        id: tag-release
        with:
          path: charts/${{ matrix.chart }}
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: helm
          monorepo-tags: true
          package-name: ${{ matrix.chart }}
          command: github-release
  release-pr:
    runs-on: ubuntu-latest
    needs:
      - release-please-release
    strategy:
      fail-fast: false
      matrix:
        chart: ${{fromJson(needs.changeFinder.outputs.changedCharts)}}
    steps:
      - uses: google-github-actions/release-please-action@v3
        id: release-please
        with:
          path: chart/${{ matrix.chart }}
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: helm
          package-name: ${{ matrix.chart }}
          monorepo-tags: true
          command: release-pr
